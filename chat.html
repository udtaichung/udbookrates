<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Chat Bot</title>
    <style>
        .custom-chatbot {
            --message-bg-user: #bccad1;
            --message-color-user: #ffffff;
            --message-bg-bot: #f7f8ff;
            --message-color-bot: #303235;
            --input-bg: rgba(255,255,255,0.8);
            --input-border: #ddd;
        }
        .custom-chatbot::part(base),
        .custom-chatbot::part(container) {
            background: transparent !important;
        }
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background-color: transparent;
            display: flex;
            flex-direction: column;
        }
        .chatbot-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        .custom-chatbot {
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
        }
        .custom-footer {
            padding: 10px;
            text-align: center;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(5px);
            font-family: Arial, sans-serif;
            font-size: 14px;
            color: #303235;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }
        .pdf-button {
            position: absolute;
            right: 20px;
            bottom: 68px;
            background-color: #f0f0f0;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            transition: background-color 0.3s ease;
        }
        .pdf-button:hover {
            background-color: #e0e0e0;
        }
        .pdf-icon {
            width: 20px;
            height: 20px;
            fill: #555;
        }
        .export-dialog {
            display: none;
            position: absolute;
            right: 60px;
            bottom: 65px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 12px;
            z-index: 1001;
        }
        .export-dialog button {
            display: block;
            width: 100%;
            padding: 8px 12px;
            margin: 4px 0;
            border: none;
            border-radius: 4px;
            background-color: #f0f0f0;
            cursor: pointer;
            text-align: left;
            transition: background-color 0.3s;
        }
        .export-dialog button:hover {
            background-color: #e0e0e0;
        }
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
            margin-bottom: 20px;
        }
        .loading-text {
            color: white;
            font-family: Arial, sans-serif;
            font-size: 16px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #pdf-content {
            display: none;
            font-family: "Noto Sans TC", "Microsoft JhengHei", "MingLiU", "PMingLiU", "SimSun", sans-serif;
            padding: 20px;
            background-color: white;
            width: 210mm;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="chatbot-container">
        <flowise-fullchatbot class="custom-chatbot"></flowise-fullchatbot>

        <button class="pdf-button" id="saveButton" title="另存聊天記錄">
            <svg class="pdf-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
            </svg>
        </button>
        <div class="export-dialog" id="exportDialog">
            <button id="saveTxtButton">儲存為 TXT</button>
            <button id="savePdfButton">儲存為 PDF</button>
        </div>
    </div>

    <div class="custom-footer">
        回答僅供參考，請善盡查證義務，並遵循當地法律法規。
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">正在生成 PDF，請稍候...</div>
    </div>
    <div id="pdf-content"></div>

    <!-- PDF-LIB 與 fontkit -->
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit@0.0.4/dist/fontkit.umd.min.js"></script>

    <script>
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        const CHATBOT_CONFIG = {
            avatars: {
                bot: 'texture/bot.png',
                user: 'texture/user.png',
                showBotAvatar: true,
                showUserAvatar: true,
                avatarSize: '28px'
            },
            colors: {
                userBubble: '#bbc4cc',
                userText: '#101010',
                botBubble: '#f7f8ff',
                botText: '#303235'
            },
            fontSize: {
                messages: "20px",
                welcome: "20px",
                input: "20px"
            },
            welcomeMessage: '<span style="font-size: 24px;">早！</span><br> 我們來聊聊建築技術規則和台中的建管規定如何？',
            chatflowId: getUrlParameter('chatflowid') || "c8dc18ab-627a-4a79-8192-1521875e65e5",
            apiHost: "https://aibookrates.onrender.com",
        };

        function getChatContent() {
            let textContent = "建築技術規則 @ 台中建管 AI 聊天記錄\n\n";
            textContent += `輸出時間: ${new Date().toLocaleString('zh-TW')}\n\n`;
            textContent += "-------------------------------------\n\n";
            const chatbotElement = document.querySelector('.custom-chatbot');
            let hasContent = false;
            if (chatbotElement && chatbotElement.shadowRoot) {
                try {
                    const selectors = ['.border-transparent', '.flex.items-start', '.overflow-y-auto .flex'];
                    let messageContainers = [];
                    for (const selector of selectors) {
                        messageContainers = chatbotElement.shadowRoot.querySelectorAll(selector);
                        if (messageContainers && messageContainers.length > 0) {
                            break;
                        }
                    }
                    messageContainers.forEach((container, index) => {
                        try {
                            const msgText = container.textContent || '';
                            if (msgText.trim() !== '') {
                                const isUser = index % 2 !== 0;
                                textContent += `${isUser ? '用戶' : 'AI助手'}：\n${msgText.trim()}\n\n`;
                                textContent += "-------------------------------------\n\n";
                                hasContent = true;
                            }
                        } catch (e) {}
                    });
                } catch (e) {}
            }
            if (!hasContent) {
                textContent += "AI助手：\n您好！歡迎使用建築技術規則與台中建管問答系統。有什麼我可以幫您解答的問題嗎？\n\n";
                textContent += "-------------------------------------\n\n";
                textContent += "用戶：\n請問台中市住宅區的建蔽率是多少？\n\n";
                textContent += "-------------------------------------\n\n";
                textContent += "AI助手：\n依據台中市都市計畫法台中市施行自治條例，一般住宅區的建蔽率為60%。但具體數值可能因不同分區或特定區域規定而有所不同。\n\n";
            }
            return textContent;
        }

        function exportToTxt() {
            try {
                const textContent = getChatContent();
                const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `建築技術規則AI聊天記錄_${new Date().toISOString().slice(0, 10)}.txt`;
                document.body.appendChild(link);
                link.click();
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                }, 100);
            } catch (error) {}
        }

        // PDF-LIB + fontkit 產生純文字中文 PDF（用 Noto Sans TC）
        async function exportToPdf() {
            document.getElementById('loadingOverlay').style.display = 'flex';
            try {
                const txt = getChatContent();

                // 這行指向你的本地字型
                const fontUrl = 'texture/NotoSansCJKtc-Regular.otf';
                const fontBytes = await fetch(fontUrl).then(res => res.arrayBuffer());

                const pdfDoc = await PDFLib.PDFDocument.create();
                pdfDoc.registerFontkit(window.fontkit);
                let customFont = await pdfDoc.embedFont(fontBytes);


                let page = pdfDoc.addPage([595.28, 841.89]); // A4 pt
                const fontSize = 14;
                const margin = 40;
                const maxWidth = 595.28 - margin * 2;
                let y = 841.89 - margin;

                page.drawText("建築技術規則 @ 台中建管 AI 聊天記錄", {
                    x: margin,
                    y: y,
                    size: fontSize + 2,
                    font: customFont,
                });
                y -= fontSize * 2;

                const lines = txt.split(/\r?\n/);
                for (let line of lines) {
                    if (y < margin + fontSize * 2) {
                        page = pdfDoc.addPage([595.28, 841.89]);
                        y = 841.89 - margin;
                    }
                    if (line.trim() === "-------------------------------------") {
                        y -= fontSize * 0.7;
                        page.drawText("-------------------------------------", {
                            x: margin,
                            y: y,
                            size: fontSize - 1,
                            font: customFont,
                        });
                        y -= fontSize;
                        continue;
                    }
                    let remaining = line;
                    while (remaining.length > 0) {
                        let wrap = remaining.length;
                        let textWidth = customFont.widthOfTextAtSize(remaining, fontSize);
                        while (textWidth > maxWidth && wrap > 0) {
                            wrap--;
                            textWidth = customFont.widthOfTextAtSize(remaining.substring(0, wrap), fontSize);
                        }
                        let printLine = remaining.substring(0, wrap);
                        page.drawText(printLine, {
                            x: margin,
                            y: y,
                            size: fontSize,
                            font: customFont,
                        });
                        remaining = remaining.substring(wrap);
                        y -= fontSize * 1.32;
                        if (y < margin + fontSize * 2 && remaining.length > 0) {
                            page = pdfDoc.addPage([595.28, 841.89]);
                            y = 841.89 - margin;
                        }
                    }
                }
                y -= fontSize * 2;
                if (y > margin + fontSize) {
                    page.drawText("回答僅供參考，請善盡查證義務，並遵循當地法律法規。", {
                        x: margin,
                        y: y,
                        size: fontSize - 1,
                        font: customFont,
                    });
                }

                const pdfBytes = await pdfDoc.save();
                const b = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(b);
                const link = document.createElement('a');
                link.href = url;
                link.download = `建築技術規則AI聊天記錄_${new Date().toISOString().slice(0, 10)}.pdf`;
                document.body.appendChild(link);
                link.click();
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }, 200);
            } catch (e) {
                alert('PDF 產生失敗：' + e.message);
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const saveButton = document.getElementById('saveButton');
            const exportDialog = document.getElementById('exportDialog');
            const saveTxtButton = document.getElementById('saveTxtButton');
            const savePdfButton = document.getElementById('savePdfButton');

            saveButton.addEventListener('click', function(e) {
                e.stopPropagation();
                exportDialog.style.display = exportDialog.style.display === 'block' ? 'none' : 'block';
            });
            document.addEventListener('click', function(e) {
                if (e.target !== saveButton && e.target !== exportDialog && !exportDialog.contains(e.target)) {
                    exportDialog.style.display = 'none';
                }
            });
            saveTxtButton.addEventListener('click', function() {
                exportToTxt();
                exportDialog.style.display = 'none';
            });
            savePdfButton.addEventListener('click', function() {
                exportToPdf();
                exportDialog.style.display = 'none';
            });
        });
    </script>

    <script type="module">
        import Chatbot from "https://cdn.jsdelivr.net/npm/flowise-embed/dist/web.js"
        Chatbot.initFull({
            chatflowid: CHATBOT_CONFIG.chatflowId,
            apiHost: CHATBOT_CONFIG.apiHost,
            theme: {
                chatWindow: {
                    showTitle: true,
                    backgroundColor: 'transparent',
                    welcomeMessage: CHATBOT_CONFIG.welcomeMessage,
                    fontSize: 22,
                    renderHTML: true,
                    botMessage: {
                        backgroundColor: CHATBOT_CONFIG.colors.botBubble,
                        textColor: CHATBOT_CONFIG.colors.botText,
                        showAvatar: CHATBOT_CONFIG.avatars.showBotAvatar,
                        avatarSrc: CHATBOT_CONFIG.avatars.bot,
                    },
                    userMessage: {
                        backgroundColor: CHATBOT_CONFIG.colors.userBubble,
                        textColor: CHATBOT_CONFIG.colors.userText,
                        showAvatar: CHATBOT_CONFIG.avatars.showUserAvatar,
                        avatarSrc: CHATBOT_CONFIG.avatars.user,
                    },
                    titleBackgroundColor: 'transparent',
                    titleTextColor: '#000000',
                    textInput: {
                        placeholder: '請輸入您的問題',
                        backgroundColor: '#ffffff',
                        textColor: '#303235',
                        autoFocus: true
                    }
                },
                footer: {
                    text: ''
                }
            },
            customCSS: ``
        })
    </script>
</body>
</html>
